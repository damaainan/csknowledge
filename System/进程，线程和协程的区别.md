## 进程，线程和协程的区别

2017.12.06 10:41*

来源：[https://www.jianshu.com/p/6788a51d32aa](https://www.jianshu.com/p/6788a51d32aa)

 **`一、进程`** 

操作系统中最核心的概念是进程，分布式系统中最重要的问题是进程间通信。 **`进程`** 是“程序执行的一个实例” ，担当分配系统资源的实体。进程创建必须分配一个完整的独立地址空间。 **`进程切换`** 只发生在内核态，两步：1 切换页全局目录以安装一个新的地址空间 2 切换内核态堆栈和硬件上下文。  另一种说法类似：1 保存CPU环境（寄存器值、程序计数器、堆栈指针）2修改内存管理单元MMU的寄存器 3 转换后备缓冲器TLB中的地址转换缓存内容标记为无效。

二、线程

书中的定义：线程是进程的一个执行流，独立执行它自己的程序代码。

是[操作系统][0]能够进行运算[调度][1]的最小单位。

线程上下文一般只包含CPU上下文及其他的线程管理信息。线程创建的开销主要取决于为线程堆栈的建立而分配内存的开销，这些开销并不大。线程上下文切换发生在两个线程需要同步的时候，比如进入共享数据段。切换只CPU寄存器值需要存储，并随后用将要切换到的线程的原先存储的值重新加载到CPU寄存器中去。

用户级线程主要缺点在于对引起阻塞的系统调用的调用会立即阻塞该线程所属的整个进程。内核实现线程则会导致线程上下文切换的开销跟进程一样大，所以折衷的方法是轻量级进程（Lightweight）。在linux中，一个线程组基本上就是实现了多线程应用的一组轻量级进程。我理解为 进程中存在用户线程、轻量级进程、内核线程。

语言层面实现轻量级进程的比较少，stackless python，erlang支持，java并不支持。 **`三、协程`** 

协程的定义？颜开、许式伟均只说

协程是轻量级的线程，一个进程可轻松创建数十万计的协程。仔细研究下，个人感觉这些都是忽悠人的说法。从维基百科上看，从Knuth老爷子的基本算法卷上看“子程序其实是协程的特例”。子程序是什么？ **`子程序`** ），就是函数嘛！所以协程也没什么了不起的，就是种更一般意义的程序组件，那你内存空间够大，创建多少个函数还不是随你么？

协程可以通过yield来调用其它协程。通过yield方式转移执行权的协程之间不是调用者与被调用者的关系，而是彼此对称、平等的。协程的起始处是第一个入口点，在协程里，返回点之后是接下来的入口点。子例程的生命期遵循后进先出（最后一个被调用的子例程最先返回）；相反，协程的生命期完全由他们的使用的需要决定。 **`线程和协程的区别：`** 

一旦创建完线程，你就无法决定他什么时候获得时间片，什么时候让出时间片了，你把它交给了内核。而协程编写者可以有

一是可控的切换时机，二是很小的切换代价。

从操作系统有没有调度权上看，协程就是因为不需要进行内核态的切换，所以会使用它，会有这么个东西。赖永浩和dccmx 这个定义我觉得相对准确  协程－

用户态的轻量级的线程。（[http://blog.dccmx.com/2011/04/coroutine-concept/][2]） **`四、go中的Goroutine`** 

go中的Goroutine， 普遍认为是协程的go语言实现。《Go语言编程》中说goroutine是轻量级线程(即协程coroutine, 原书90页). 在第九章进阶话题中, 作者又一次提到, "从根本上来说, goroutine就是一种go语言版本的协程(coroutine)" (原书204页). 但作者[Rob Pike][3]并不这么说。 **`“一个Goroutine是一个与其他goroutines 并发运行在同一地址空间的Go函数或方法。一个运行的程序由一个或更多个goroutine组成。`**  它与线程、协程、进程等不同。它是一个goroutine。

[reference][4]


[0]: https://link.jianshu.com?t=http://zh.wikipedia.org/wiki/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F
[1]: https://link.jianshu.com?t=http://zh.wikipedia.org/wiki/%E8%B0%83%E5%BA%A6
[2]: https://link.jianshu.com?t=http://blog.dccmx.com/2011/04/coroutine-concept/
[3]: https://link.jianshu.com?t=http://en.wikipedia.org/wiki/Rob_Pike
[4]: https://link.jianshu.com?t=https://www.cnblogs.com/shenguanpu/archive/2013/05/05/3060616.html